---
import Footer from '../components/Footer.astro'
import Navbar from '../components/Navbar.astro'
import { capitalizeFirstLetter, currentPage } from '../utils'
import { getImage } from '@astrojs/image'
import '../assets/styles/tailwind.css'

type LayoutProps = {
  title?: string
  navbar?: boolean
  navbarNoBg?: boolean
  ogImage?: string
  ogTitle?: string
  ogDescription?: string
  noFooter?: boolean
}

const url = new URL(Astro.request.url)
const currentPageName =
  currentPage(url.pathname) || (url.pathname === '/' && 'home')

type Metadata = {
  homepage: {
    featuredBlogs: string[]
    featuredCaseStudies: string[]
  }
  navbar: { label: string; href: string }[]
  footer: { label: string; href: string; flag?: string }[]
  seo: Record<string, { description: string; image?: string }>
}

const { title, navbar, navbarNoBg, ogImage, ogTitle, ogDescription, noFooter } =
  Astro.props as LayoutProps

const [{ seo }] = await Astro.glob<Metadata>('../data/metadata.json')

const currentDescription =
  ogDescription ?? (seo[currentPageName] && seo[currentPageName].description)

// image attributes must be all jpgs and located in src/assets/images/ dir
let imageForShare
if (seo[currentPageName] && seo[currentPageName].image) {
  const imgNoExt = seo[currentPageName].image.split('.').slice(0, -1).join('.')
  let importedPic = await getImage({
    src: import(`../assets/images/${imgNoExt}.jpg`),
    width: 1700,
    alt: 'background',
    quality: 90
  }).then((img) => img.src)
  imageForShare = `${url.origin}${importedPic}`
}

const metaTitle = ogTitle ?? currentPageName
---

<!DOCTYPE html>
<html lang='it'>
  <head>
    <meta charset='UTF-8' />
    {
      currentDescription && (
        <meta name='description' content={currentDescription} />
      )
    }
    <!-- Meta Tags -->
    <meta property='og:url' content={url.href} />
    <meta property='og:type' content='website' />
    <meta property='og:title' content={metaTitle} />
    {
      currentDescription && (
        <meta property='og:description' content={currentDescription} />
      )
    }
    {imageForShare && <meta property='og:image' content={imageForShare} />}
    {
      imageForShare && (
        <meta property='og:image:secure_url' content={imageForShare} />
      )
    }

    <!-- Twitter Meta Tags -->
    <meta name='twitter:card' content='summary_large_image' />
    <meta property='twitter:domain' content={url.hostname} />
    <meta property='twitter:url' content={url.href} />
    <meta name='twitter:title' content={metaTitle} />
    {
      currentDescription && (
        <meta name='twitter:description' content={currentDescription} />
      )
    }
    {imageForShare && <meta name='twitter:image' content={imageForShare} />}

    <meta name='viewport' content='width=device-width' />
    <link href='/images/favicon.ico' rel='shortcut icon' type='image/x-icon' />
    
    <!-- Google Fonts - Elegant Typography -->
    <link rel='preconnect' href='https://fonts.googleapis.com' />
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin />
    <link
      href='https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap'
      rel='stylesheet'
    />

    <title>{title || capitalizeFirstLetter(currentPageName)}</title>
    
    <!-- Theme initialization -->
    <script>
      const root = document.documentElement
      const theme = localStorage.getItem('theme')
      if (
        theme === 'dark' ||
        (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        root.classList.add('dark')
        document.documentElement.style.setProperty('color-scheme', 'dark')
      } else {
        document.documentElement.style.setProperty('color-scheme', 'light')
        root.classList.remove('dark')
      }
    </script>
    
    <style>
      html {
        scroll-behavior: smooth;
      }
      
      /* Base elegant styling */
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      
      /* Elegant selection */
      ::selection {
        background-color: #3D8AAD;
        color: white;
      }
      
      /* Smooth image loading */
      img {
        transition: opacity 0.3s ease;
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: #FAF8F5;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #C7B9A8;
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #A89780;
      }
      
      .dark ::-webkit-scrollbar-track {
        background: #1A1C1F;
      }
      
      .dark ::-webkit-scrollbar-thumb {
        background: #4D5159;
      }
    </style>
  </head>
  <body class='bg-sand-50 text-ink-800 font-sans transition-colors duration-300 dark:bg-ink-900 dark:text-sand-100'>
    {navbar && <Navbar navbarNoBg={navbarNoBg} />}
    <div class:list={[{ 'pt-16': !navbarNoBg && navbar }]}>
      <slot />
      {!noFooter && <Footer />}
    </div>
  </body>
</html>
